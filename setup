#!/bin/sh
#
# Initial system setup for bare metal perfSONAR test bed host
#

# Currently-supported version of VirtualBox.
VBOX_VERSION=6.1

die()
{
    echo "$@" 2>&1
    exit 1
}

if [ "$(id -nu)" != "root" ]
then
   die "This program must be run as root."
fi

if [ -e "/etc/redhat-release" ]
then

    echo "Setting up something Red Hat-flavored"

    yum -y update
    
    # Install VirtualBox    
    rpm --import https://www.virtualbox.org/download/oracle_vbox.asc
    curl -s -o /etc/yum.repos.d/virtualbox.repo \
	 https://download.virtualbox.org/virtualbox/rpm/el/virtualbox.repo
    yum -y makecache
    yum -y install VirtualBox-${VBOX_VERSION}

    # Install Vagrant
    yum install -y yum-utils
    yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
    yum -y install vagrant git make kernel-devel

elif [ -e "/etc/debian_version" ]
then

    echo "Setting up something Debian-flavored"

    echo
    echo "*** WARNING:  THIS IS UNTESTED***"
    echo

    apt -y update
    apt -y upgrade

    # TODO: Install VirtualBox
    
    curl -s https://apt.releases.hashicorp.com/gpg \
	| gpg --dearmor \
	> tee /usr/share/keyrings/hashicorp-archive-keyring.gpg

    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg]" \
	 "https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
	> /etc/apt/sources.list.d/hashicorp.list

    apt update
    apt -y install vagrant git make kernel-devel

else

    die "No idea how to support this OS.  Sorry."

fi


rm -f "/lib/modules/$(uname -r)/build"
ln -s "/usr/src/kernels/$(uname -r)" "/lib/modules/$(uname -r)/build"
/sbin/vboxconfig

TESTBED_USER=testbed
if ! getent passwd "${TESTBED_USER}" > /dev/null
then
    useradd -c 'perfSONAR Testbed' testbed
fi

su - "${TESTBED_USER}" -c "vagrant plugin install netaddr"

TESTBED_HOME=$(getent passwd "${TESTBED_USER}" | cut -d: -f 6)
su - "${TESTBED_USER}" -c "git -C '${TESTBED_HOME}' clone https://github.com/perfsonar/testbed-bare-metal-host.git"

echo "Setup was Successful."
echo "Configuration is in ${TESTBED_HOME}/testbed-bare-metal-host." 

exit 0
